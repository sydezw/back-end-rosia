# Corre√ß√£o - Sess√£o Expirando Imediatamente Ap√≥s Login

## üö® Problema Identificado

A sess√£o do Supabase est√° expirando imediatamente ap√≥s o login, causando:

```
Sua sess√£o expirou. Fa√ßa login novamente.
Unchecked runtime.lastError: The message port closed before a response was received.
üì• Carregando dados do usu√°rio via backend...
‚ùå Erro de sess√£o: null
404 Error: User attempted to access non-existent route: /login
```

### Causas do Problema:
1. **Configura√ß√£o incorreta do Supabase Client**
2. **Persist√™ncia de sess√£o n√£o configurada**
3. **Rota /login n√£o existe no frontend**
4. **Verifica√ß√£o de sess√£o inadequada**
5. **Poss√≠vel conflito entre localStorage e sessionStorage**

## ‚úÖ Solu√ß√£o Completa

### 1. Configura√ß√£o Correta do Supabase Client

**Arquivo: `config/supabase.js` ou `supabase.ts`**

```javascript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = 'https://nsazbeovtmmetpiyokqc.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zYXpiZW92dG1tZXRwaXlva3FjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzY5NzEsImV4cCI6MjA1MDU1Mjk3MX0.Ej8nkGJBhn_r7wgmkdmKQBJbJNJhLLJhKQJhKQJhKQJ';

// ‚úÖ CONFIGURA√á√ÉO CORRETA COM PERSIST√äNCIA DE SESS√ÉO
export const supabase = createClient(supabaseUrl, supabaseAnonKey, {
  auth: {
    // Configurar persist√™ncia de sess√£o
    storage: window.localStorage, // Usar localStorage para persistir sess√£o
    storageKey: 'supabase.auth.token', // Chave personalizada
    autoRefreshToken: true, // Renovar token automaticamente
    persistSession: true, // Manter sess√£o ativa
    detectSessionInUrl: true, // Detectar sess√£o na URL (importante para OAuth)
    flowType: 'pkce' // Usar PKCE flow para seguran√ßa
  },
  // Configura√ß√µes globais
  global: {
    headers: {
      'X-Client-Info': 'supabase-js-web'
    }
  },
  // Configura√ß√µes de realtime (opcional)
  realtime: {
    params: {
      eventsPerSecond: 2
    }
  }
});

// ‚úÖ FUN√á√ÉO PARA VERIFICAR E RESTAURAR SESS√ÉO
export const initializeAuth = async () => {
  try {
    console.log('üîç Inicializando autentica√ß√£o...');
    
    // Verificar se h√° sess√£o salva
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error('‚ùå Erro ao obter sess√£o:', error);
      return { session: null, error };
    }
    
    if (session) {
      console.log('‚úÖ Sess√£o encontrada:', {
        user: session.user.email,
        expires_at: new Date(session.expires_at * 1000).toLocaleString(),
        access_token: session.access_token ? 'Presente' : 'Ausente'
      });
      
      // Verificar se o token n√£o est√° expirado
      const now = Math.floor(Date.now() / 1000);
      if (session.expires_at && session.expires_at < now) {
        console.log('‚ö†Ô∏è Token expirado, tentando renovar...');
        
        const { data: refreshData, error: refreshError } = await supabase.auth.refreshSession();
        
        if (refreshError) {
          console.error('‚ùå Erro ao renovar sess√£o:', refreshError);
          return { session: null, error: refreshError };
        }
        
        console.log('‚úÖ Sess√£o renovada com sucesso');
        return { session: refreshData.session, error: null };
      }
      
      return { session, error: null };
    } else {
      console.log('‚ÑπÔ∏è Nenhuma sess√£o encontrada');
      return { session: null, error: null };
    }
    
  } catch (error) {
    console.error('‚ùå Erro na inicializa√ß√£o da auth:', error);
    return { session: null, error };
  }
};

// ‚úÖ LISTENER PARA MUDAN√áAS DE AUTENTICA√á√ÉO
export const setupAuthListener = (callback) => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange(
    async (event, session) => {
      console.log('üîÑ Mudan√ßa de autentica√ß√£o:', event, session?.user?.email || 'Sem usu√°rio');
      
      switch (event) {
        case 'SIGNED_IN':
          console.log('‚úÖ Usu√°rio logado:', session.user.email);
          break;
        case 'SIGNED_OUT':
          console.log('üö™ Usu√°rio deslogado');
          // Limpar dados locais
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('userEmail');
          break;
        case 'TOKEN_REFRESHED':
          console.log('üîÑ Token renovado para:', session.user.email);
          break;
        case 'USER_UPDATED':
          console.log('üë§ Usu√°rio atualizado:', session.user.email);
          break;
      }
      
      if (callback) {
        callback(event, session);
      }
    }
  );
  
  return subscription;
};

// ‚úÖ FUN√á√ÉO PARA LOGOUT SEGURO
export const signOut = async () => {
  try {
    console.log('üö™ Fazendo logout...');
    
    const { error } = await supabase.auth.signOut();
    
    if (error) {
      console.error('‚ùå Erro no logout:', error);
      return { success: false, error };
    }
    
    // Limpar dados locais
    localStorage.clear();
    sessionStorage.clear();
    
    console.log('‚úÖ Logout realizado com sucesso');
    return { success: true, error: null };
    
  } catch (error) {
    console.error('‚ùå Erro inesperado no logout:', error);
    return { success: false, error };
  }
};
```

### 2. Componente ProfileSettings Corrigido

**Arquivo: `ProfileSettings.tsx`**

```typescript
import React, { useState, useEffect } from 'react';
import { supabase, initializeAuth, setupAuthListener } from './config/supabase';
import { updateUserProfile, getUserProfile } from './profile-api';

const ProfileSettings = () => {
  const [user, setUser] = useState(null);
  const [session, setSession] = useState(null);
  const [profileData, setProfileData] = useState({
    nome: '',
    cpf: '',
    telefone: '',
    data_nascimento: ''
  });
  const [addressData, setAddressData] = useState({
    nome_endereco: '',
    cep: '',
    logradouro: '',
    numero: '',
    bairro: '',
    cidade: '',
    estado: '',
    complemento: ''
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [message, setMessage] = useState('');
  const [authSubscription, setAuthSubscription] = useState(null);
  
  useEffect(() => {
    initializeComponent();
    
    // Cleanup na desmontagem
    return () => {
      if (authSubscription) {
        authSubscription.unsubscribe();
      }
    };
  }, []);
  
  const initializeComponent = async () => {
    try {
      setLoading(true);
      console.log('üîç Inicializando ProfileSettings...');
      
      // ‚úÖ INICIALIZAR AUTENTICA√á√ÉO CORRETAMENTE
      const { session: currentSession, error } = await initializeAuth();
      
      if (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        setIsAuthenticated(false);
        setMessage('Erro de autentica√ß√£o: ' + error.message);
        return;
      }
      
      if (!currentSession?.user) {
        console.log('‚ùå Usu√°rio n√£o autenticado');
        setIsAuthenticated(false);
        setMessage('Sua sess√£o expirou. Redirecionando para login...');
        
        // Redirecionar para p√°gina de login ap√≥s 2 segundos
        setTimeout(() => {
          window.location.href = '/auth/login'; // ‚úÖ ROTA CORRETA
        }, 2000);
        return;
      }
      
      console.log('‚úÖ Usu√°rio autenticado:', currentSession.user.email);
      setUser(currentSession.user);
      setSession(currentSession);
      setIsAuthenticated(true);
      
      // ‚úÖ CONFIGURAR LISTENER DE AUTENTICA√á√ÉO
      const subscription = setupAuthListener((event, newSession) => {
        if (event === 'SIGNED_OUT' || !newSession) {
          console.log('üö™ Usu√°rio deslogado, redirecionando...');
          setIsAuthenticated(false);
          setUser(null);
          setSession(null);
          window.location.href = '/auth/login';
        } else if (event === 'TOKEN_REFRESHED') {
          console.log('üîÑ Token renovado, atualizando sess√£o...');
          setSession(newSession);
        }
      });
      
      setAuthSubscription(subscription);
      
      // Carregar dados do usu√°rio
      await loadUserData();
      
    } catch (error) {
      console.error('‚ùå Erro na inicializa√ß√£o:', error);
      setIsAuthenticated(false);
      setMessage('Erro inesperado na inicializa√ß√£o');
    } finally {
      setLoading(false);
    }
  };
  
  const loadUserData = async () => {
    try {
      console.log('üì• Carregando dados do usu√°rio via backend...');
      
      // ‚úÖ VERIFICAR SESS√ÉO ANTES DE CARREGAR DADOS
      const { data: { session: currentSession }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('‚ùå Erro de sess√£o:', sessionError);
        setMessage('Erro de sess√£o: ' + sessionError.message);
        return;
      }
      
      if (!currentSession) {
        console.error('‚ùå Sess√£o n√£o encontrada');
        setMessage('Sess√£o expirada. Redirecionando...');
        setTimeout(() => {
          window.location.href = '/auth/login';
        }, 2000);
        return;
      }
      
      const result = await getUserProfile();
      
      if (result.success) {
        // Preencher formul√°rios com dados existentes
        if (result.profile) {
          setProfileData({
            nome: result.profile.nome || '',
            cpf: result.profile.cpf || '',
            telefone: result.profile.telefone || '',
            data_nascimento: result.profile.data_nascimento || ''
          });
        }
        
        if (result.address) {
          setAddressData({
            nome_endereco: result.address.nome_endereco || '',
            cep: result.address.cep || '',
            logradouro: result.address.logradouro || '',
            numero: result.address.numero || '',
            bairro: result.address.bairro || '',
            cidade: result.address.cidade || '',
            estado: result.address.estado || '',
            complemento: result.address.complemento || ''
          });
        }
        
        console.log('‚úÖ Dados carregados com sucesso');
      } else {
        console.log('‚ÑπÔ∏è Nenhum dado encontrado, formul√°rios vazios');
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar dados:', error);
      setMessage('Erro ao carregar dados existentes');
    }
  };
  
  const handleSave = async () => {
    try {
      setSaving(true);
      setMessage('');
      
      // ‚úÖ VERIFICAR SESS√ÉO ANTES DE SALVAR
      const { data: { session: currentSession }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError || !currentSession) {
        setMessage('‚ùå Sess√£o expirada. Fa√ßa login novamente.');
        setTimeout(() => {
          window.location.href = '/auth/login';
        }, 2000);
        return;
      }
      
      console.log('üíæ Salvando dados...');
      
      const result = await updateUserProfile(profileData, addressData);
      
      if (result.success) {
        setMessage('‚úÖ Dados salvos com sucesso!');
        console.log('‚úÖ Dados salvos:', result);
      } else {
        setMessage('‚ùå Erro ao salvar: ' + result.error);
        console.error('‚ùå Erro ao salvar:', result.error);
      }
      
    } catch (error) {
      console.error('‚ùå Erro no salvamento:', error);
      setMessage('‚ùå Erro inesperado ao salvar dados');
    } finally {
      setSaving(false);
    }
  };
  
  const handleLogout = async () => {
    try {
      console.log('üö™ Iniciando logout...');
      
      const { error } = await supabase.auth.signOut();
      
      if (error) {
        console.error('Erro no logout:', error);
      }
      
      // Limpar dados locais
      localStorage.clear();
      sessionStorage.clear();
      
      // Redirecionar para login
      window.location.href = '/auth/login';
      
    } catch (error) {
      console.error('Erro no logout:', error);
      window.location.href = '/auth/login';
    }
  };
  
  // ‚úÖ TELA DE LOADING MELHORADA
  if (loading) {
    return (
      <div className="loading-container">
        <div className="spinner"></div>
        <h3>üîç Verificando autentica√ß√£o...</h3>
        <p>Aguarde enquanto carregamos suas informa√ß√µes...</p>
      </div>
    );
  }
  
  // ‚úÖ TELA DE LOGIN NECESS√ÅRIO MELHORADA
  if (!isAuthenticated) {
    return (
      <div className="auth-required">
        <h2>üîê Acesso Restrito</h2>
        <p>Sua sess√£o expirou ou voc√™ n√£o est√° logado.</p>
        {message && (
          <div className="error-message">
            {message}
          </div>
        )}
        <button onClick={() => window.location.href = '/auth/login'}>
          üîë Fazer Login
        </button>
      </div>
    );
  }
  
  // Resto do componente permanece igual...
  return (
    <div className="profile-settings">
      <div className="profile-header">
        <h1>üë§ Minhas Informa√ß√µes</h1>
        <div className="user-info">
          <p>üìß {user?.email}</p>
          <p>üïí Sess√£o v√°lida at√©: {session?.expires_at ? new Date(session.expires_at * 1000).toLocaleString() : 'N/A'}</p>
        </div>
        <button onClick={handleLogout} className="logout-btn">
          üö™ Sair
        </button>
      </div>
      
      {message && (
        <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
          {message}
        </div>
      )}
      
      {/* Resto dos formul√°rios... */}
      <div className="save-section">
        <button 
          onClick={handleSave}
          disabled={saving}
          className="save-btn"
        >
          {saving ? 'üíæ Salvando...' : 'üíæ Salvar Altera√ß√µes'}
        </button>
      </div>
    </div>
  );
};

export default ProfileSettings;
```

### 3. Configura√ß√£o de Rotas do Frontend

**Arquivo: `App.tsx` ou `Router.tsx`**

```typescript
import React from 'react';
import { BrowserRouter as Router, Routes, Route, Navigate } from 'react-router-dom';
import ProfileSettings from './components/ProfileSettings';
import Login from './components/Login';
import NotFound from './components/NotFound';

function App() {
  return (
    <Router>
      <Routes>
        {/* ‚úÖ ROTA DE LOGIN CORRETA */}
        <Route path="/auth/login" element={<Login />} />
        <Route path="/login" element={<Navigate to="/auth/login" replace />} />
        
        {/* ‚úÖ ROTA DE PERFIL */}
        <Route path="/profile" element={<ProfileSettings />} />
        <Route path="/minhas-informacoes" element={<Navigate to="/profile" replace />} />
        
        {/* ‚úÖ ROTA INICIAL */}
        <Route path="/" element={<Navigate to="/profile" replace />} />
        
        {/* ‚úÖ ROTA 404 */}
        <Route path="*" element={<NotFound />} />
      </Routes>
    </Router>
  );
}

export default App;
```

### 4. Componente de Login Atualizado

**Arquivo: `Login.tsx`**

```typescript
import React, { useState, useEffect } from 'react';
import { supabase, initializeAuth } from './config/supabase';

const Login = () => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [message, setMessage] = useState('');
  const [checkingAuth, setCheckingAuth] = useState(true);
  
  useEffect(() => {
    checkExistingAuth();
  }, []);
  
  const checkExistingAuth = async () => {
    try {
      const { session } = await initializeAuth();
      
      if (session?.user) {
        console.log('‚úÖ Usu√°rio j√° logado, redirecionando...');
        window.location.href = '/profile';
        return;
      }
      
    } catch (error) {
      console.error('Erro ao verificar autentica√ß√£o:', error);
    } finally {
      setCheckingAuth(false);
    }
  };
  
  const handleLogin = async (e) => {
    e.preventDefault();
    
    try {
      setLoading(true);
      setMessage('');
      
      console.log('üîë Tentando fazer login...');
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email: email.trim(),
        password: password
      });
      
      if (error) {
        console.error('‚ùå Erro no login:', error);
        setMessage('Erro no login: ' + error.message);
        return;
      }
      
      if (data.session) {
        console.log('‚úÖ Login realizado com sucesso:', data.user.email);
        
        // Salvar informa√ß√µes locais
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('userEmail', data.user.email);
        
        setMessage('‚úÖ Login realizado com sucesso! Redirecionando...');
        
        // Redirecionar ap√≥s 1 segundo
        setTimeout(() => {
          window.location.href = '/profile';
        }, 1000);
      }
      
    } catch (error) {
      console.error('‚ùå Erro inesperado:', error);
      setMessage('Erro inesperado no login');
    } finally {
      setLoading(false);
    }
  };
  
  const handleGoogleLogin = async () => {
    try {
      setLoading(true);
      setMessage('');
      
      console.log('üîë Tentando login com Google...');
      
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${window.location.origin}/profile`
        }
      });
      
      if (error) {
        console.error('‚ùå Erro no login Google:', error);
        setMessage('Erro no login Google: ' + error.message);
      }
      
    } catch (error) {
      console.error('‚ùå Erro inesperado no Google:', error);
      setMessage('Erro inesperado no login Google');
    } finally {
      setLoading(false);
    }
  };
  
  if (checkingAuth) {
    return (
      <div className="loading-container">
        <div className="spinner"></div>
        <h3>üîç Verificando autentica√ß√£o...</h3>
      </div>
    );
  }
  
  return (
    <div className="login-container">
      <div className="login-form">
        <h1>üîë Fazer Login</h1>
        
        {message && (
          <div className={`message ${message.includes('‚úÖ') ? 'success' : 'error'}`}>
            {message}
          </div>
        )}
        
        <form onSubmit={handleLogin}>
          <div className="form-group">
            <label>Email:</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              disabled={loading}
            />
          </div>
          
          <div className="form-group">
            <label>Senha:</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
              disabled={loading}
            />
          </div>
          
          <button type="submit" disabled={loading}>
            {loading ? 'üîÑ Entrando...' : 'üîë Entrar'}
          </button>
        </form>
        
        <div className="divider">ou</div>
        
        <button onClick={handleGoogleLogin} disabled={loading} className="google-btn">
          {loading ? 'üîÑ Conectando...' : 'üîë Entrar com Google'}
        </button>
      </div>
    </div>
  );
};

export default Login;
```

### 5. CSS Adicional

```css
.user-info {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.user-info p {
  margin: 0;
  font-size: 14px;
  color: #666;
}

.error-message {
  background: #f8d7da;
  color: #721c24;
  padding: 10px;
  border-radius: 6px;
  margin: 10px 0;
  border: 1px solid #f5c6cb;
}

.login-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: #f8f9fa;
}

.login-form {
  background: white;
  padding: 40px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 400px;
}

.divider {
  text-align: center;
  margin: 20px 0;
  color: #666;
  position: relative;
}

.divider::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 0;
  right: 0;
  height: 1px;
  background: #ddd;
  z-index: 1;
}

.divider span {
  background: white;
  padding: 0 15px;
  position: relative;
  z-index: 2;
}

.google-btn {
  width: 100%;
  background: #4285f4;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}

.google-btn:hover:not(:disabled) {
  background: #357ae8;
}
```

## üß™ Teste da Corre√ß√£o

### 1. Verificar no Console do Navegador

```javascript
// Testar inicializa√ß√£o da autentica√ß√£o
initializeAuth().then(result => {
  console.log('Resultado da inicializa√ß√£o:', result);
});

// Verificar sess√£o atual
supabase.auth.getSession().then(({ data, error }) => {
  console.log('Sess√£o atual:', data.session);
  console.log('Erro:', error);
});

// Testar renova√ß√£o de token
supabase.auth.refreshSession().then(({ data, error }) => {
  console.log('Renova√ß√£o:', data);
  console.log('Erro:', error);
});
```

### 2. Verificar LocalStorage

```javascript
// Verificar dados salvos
console.log('Dados no localStorage:');
console.log('supabase.auth.token:', localStorage.getItem('supabase.auth.token'));
console.log('isLoggedIn:', localStorage.getItem('isLoggedIn'));
console.log('userEmail:', localStorage.getItem('userEmail'));
```

## ‚úÖ Checklist de Implementa√ß√£o

### Configura√ß√£o:
- [ ] Atualizar configura√ß√£o do Supabase Client
- [ ] Implementar fun√ß√£o `initializeAuth()`
- [ ] Configurar listener de autentica√ß√£o
- [ ] Adicionar fun√ß√£o de logout seguro

### Componentes:
- [ ] Atualizar ProfileSettings com verifica√ß√£o de sess√£o
- [ ] Criar componente Login funcional
- [ ] Configurar rotas corretas no App
- [ ] Adicionar tratamento de erros

### Testes:
- [ ] Testar login e logout
- [ ] Verificar persist√™ncia de sess√£o
- [ ] Testar renova√ß√£o autom√°tica de token
- [ ] Verificar redirecionamentos
- [ ] Confirmar que n√£o h√° mais erro de sess√£o expirada

## üéØ Resultado Esperado

Ap√≥s implementar essas corre√ß√µes:

1. ‚úÖ Sess√£o n√£o expira imediatamente ap√≥s login
2. ‚úÖ Token √© renovado automaticamente
3. ‚úÖ Rota `/login` funciona corretamente
4. ‚úÖ Redirecionamentos funcionam adequadamente
5. ‚úÖ Dados s√£o persistidos entre recarregamentos
6. ‚úÖ Logout limpa dados corretamente
7. ‚úÖ Verifica√ß√£o de autentica√ß√£o robusta

**Agora o sistema manter√° a sess√£o ativa e funcionar√° corretamente! üöÄ**